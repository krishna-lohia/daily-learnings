name: Daily Learning Update

on:
  schedule:
    # Run every day at 3 AM UTC (8:30 AM IST)
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-learnings:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Seed learnings if empty
        run: |
          COUNT=$(python3 - <<'PY'
          import json
          with open('learnings.json','r') as f:
              data = json.load(f)
          print(len(data) if isinstance(data, list) else 0)
          PY
          )
          if [ "$COUNT" -lt 5 ]; then
            python3 seed_learnings.py
          fi

      - name: Check for new articles
        id: check
        run: python3 check_new.py

      - name: Process new article
        if: steps.check.outputs.has_new == 'true'
        env:
          NEW_URL: ${{ steps.check.outputs.new_url }}
        run: python3 process_new.py

      - name: Commit and push if changed
        if: steps.check.outputs.has_new == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add learnings.json
          git diff --staged --quiet || git commit -m "Add new daily learning"
          git push
